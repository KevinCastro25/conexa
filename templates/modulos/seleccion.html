{% extends "base.html" %}
{% block content %}

<div class="module-header-with-image">
    <div class="module-header-bg">
        <img src="{{ url_for('static', filename='images/entrevista.jpg') }}" alt="Selección de Personal">
        <div class="module-header-overlay"></div>
    </div>
    <div class="container">
        <div class="module-header-content">
            <p class="text-uppercase text-accent mb-2">Módulo de Reclutamiento</p>
            <h1>Selección de Personal</h1>
            <p class="module-description">Gestión integral del proceso de reclutamiento, desde la publicación de vacantes hasta la selección final de candidatos ideales para su organización.</p>
        </div>
    </div>
</div>

<div class="section">
    <div class="container">
        <!-- Tabs de Navegación -->
        <div class="module-tabs">
            <button class="tab-btn active" data-tab="vacantes">
                <i class="fas fa-briefcase"></i> Vacantes
            </button>
            <button class="tab-btn" data-tab="candidatos">
                <i class="fas fa-users"></i> Candidatos
            </button>
            <button class="tab-btn" data-tab="entrevistas">
                <i class="fas fa-calendar-check"></i> Entrevistas
            </button>
        </div>

        <!-- Tab Content: Vacantes -->
        <div id="vacantes-tab" class="tab-content active">
            <div class="grid grid-cols-2 gap-6">
                <!-- Nueva Vacante -->
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-plus-circle text-accent"></i> Nueva Vacante</h3>
                    <form id="newVacancyForm" class="form">
                        <div class="form-group">
                            <label for="jobTitle">Título del Cargo</label>
                            <input type="text" id="jobTitle" name="titulo" required placeholder="Ej: Desarrollador Full Stack Senior">
                        </div>
                        <div class="form-group">
                            <label for="department">Departamento</label>
                            <select id="department" name="departamento" required>
                                <option value="">Seleccione...</option>
                                <option value="tecnologia">Tecnología</option>
                                <option value="rrhh">Recursos Humanos</option>
                                <option value="ventas">Ventas</option>
                                <option value="marketing">Marketing</option>
                                <option value="finanzas">Finanzas</option>
                                <option value="operaciones">Operaciones</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="level">Nivel del Cargo</label>
                            <select id="level" name="nivel" required>
                                <option value="">Seleccione...</option>
                                <option value="junior">Junior</option>
                                <option value="middle">Middle</option>
                                <option value="senior">Senior</option>
                                <option value="lead">Lead</option>
                                <option value="manager">Manager</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="positions">Cantidad de Vacantes</label>
                            <input type="number" id="positions" name="cantidad" min="1" value="1" required>
                        </div>
                        <div class="form-group">
                            <label for="description">Descripción del Cargo</label>
                            <textarea id="description" name="descripcion" rows="4" required placeholder="Describa las responsabilidades y requisitos..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="salary">Rango Salarial</label>
                            <input type="text" id="salary" name="salario" placeholder="Ej: $3.000.000 - $5.000.000">
                        </div>
                        <button type="submit" class="btn btn-primary">Publicar Vacante</button>
                    </form>
                </div>

                <!-- Lista de Vacantes Activas -->
                <div class="card">
                    <h3 class="card-title">Vacantes Activas</h3>
                    <div id="vacanciesList" class="vacancies-list">
                        <!-- Las vacantes se cargarán aquí dinámicamente -->
                        <div class="text-center text-gray-600">
                            <i class="fas fa-spinner fa-spin"></i> Cargando vacantes...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Content: Candidatos -->
        <div id="candidatos-tab" class="tab-content">
            <div class="card">
                <h3 class="card-title">Base de Datos de Candidatos</h3>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Cargo Aplicado</th>
                                <th>Email</th>
                                <th>Teléfono</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="candidatesTable">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                    <p>Cargando candidatos...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab Content: Entrevistas -->
        <div id="entrevistas-tab" class="tab-content">
            <div class="grid grid-cols-2 gap-6">
                <div class="card">
                    <h3 class="card-title">Agendar Entrevista</h3>
                    <form id="scheduleInterviewForm" class="form">
                        <div class="form-group">
                            <label for="candidate">Candidato</label>
                            <select id="candidate" name="candidate" required>
                                <option value="">Seleccione un candidato...</option>
                                <!-- Los candidatos se cargarán dinámicamente -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="interviewDate">Fecha</label>
                            <input type="date" id="interviewDate" name="interviewDate" required>
                        </div>
                        <div class="form-group">
                            <label for="interviewTime">Hora</label>
                            <input type="time" id="interviewTime" name="interviewTime" required>
                        </div>
                        <div class="form-group">
                            <label for="interviewer">Entrevistador</label>
                            <input type="text" id="interviewer" name="interviewer" placeholder="Nombre del entrevistador">
                        </div>
                        <button type="submit" class="btn btn-primary">Agendar Entrevista</button>
                    </form>
                </div>

                <div class="card">
                    <h3 class="card-title">Próximas Entrevistas</h3>
                    <div id="interviews-list" class="interviews-list">
                        <!-- Las entrevistas se cargarán dinámicamente aquí -->
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-calendar-alt" style="font-size: 3rem; color: #ddd; margin-bottom: 15px;"></i>
                            <p>Cargando entrevistas...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Module Header with Image */
.module-header-with-image {
    position: relative;
    padding: 120px 0 80px;
    min-height: 400px;
    display: flex;
    align-items: center;
    overflow: hidden;
}

.module-header-bg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
}

.module-header-bg img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
}

.module-header-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, rgba(26, 26, 26, 0.85) 0%, rgba(26, 26, 26, 0.65) 100%);
}

.module-header-with-image .container {
    position: relative;
    z-index: 1;
}

.module-header-content {
    max-width: 700px;
}

.module-header-content h1,
.module-header-content p,
.module-header-content .text-uppercase {
    color: white;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.module-description {
    max-width: 700px;
    font-size: var(--text-lg);
    color: rgba(255, 255, 255, 0.9);
    margin: 0;
}

/* Module Specific Styles */
.module-tabs {
    display: flex;
    gap: var(--space-2);
    margin-bottom: var(--space-8);
    border-bottom: 2px solid var(--color-gray-200);
}

.tab-btn {
    padding: var(--space-4) var(--space-6);
    background: transparent;
    border: none;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    cursor: pointer;
    font-size: var(--text-sm);
    font-weight: 500;
    color: var(--color-gray-600);
    transition: all var(--transition-base);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.tab-btn:hover {
    color: var(--color-primary);
}

.tab-btn.active {
    color: var(--color-primary);
    border-bottom-color: var(--color-accent);
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

/* Vacancies List */
.vacancies-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
}

.vacancy-item {
    padding: var(--space-4);
    border: 1px solid var(--color-gray-200);
    border-radius: var(--radius-md);
    transition: all var(--transition-base);
}

.vacancy-item:hover {
    border-color: var(--color-accent);
    box-shadow: var(--shadow-md);
}

.vacancy-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-2);
}

.vacancy-header h4 {
    font-size: var(--text-lg);
    margin: 0;
}

.vacancy-meta {
    font-size: var(--text-sm);
    color: var(--color-gray-600);
    margin-bottom: var(--space-3);
}

.vacancy-actions {
    display: flex;
    gap: var(--space-2);
}

/* Badges */
.badge {
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-sm);
    font-size: var(--text-xs);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.badge-success {
    background: rgba(46, 125, 50, 0.1);
    color: var(--color-success);
}

.badge-info {
    background: rgba(2, 119, 189, 0.1);
    color: var(--color-info);
}

.badge-warning {
    background: rgba(245, 124, 0, 0.1);
    color: var(--color-warning);
}

/* Interviews */
.interviews-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
}

.interview-item {
    display: flex;
    gap: var(--space-4);
    padding: var(--space-4);
    border: 1px solid var(--color-gray-200);
    border-radius: var(--radius-md);
}

.interview-date {
    flex-shrink: 0;
    width: 60px;
    height: 60px;
    background: var(--color-accent);
    color: white;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-md);
}

.date-day {
    font-size: var(--text-2xl);
    font-weight: 700;
    line-height: 1;
}

.date-month {
    font-size: var(--text-xs);
    text-transform: uppercase;
}

.interview-info h4 {
    margin: 0 0 var(--space-1);
    font-size: var(--text-base);
}

.interview-info p {
    margin: 0;
    font-size: var(--text-sm);
    color: var(--color-gray-600);
}

/* Additional utility classes */
.text-center {
    text-align: center;
}

.text-gray-600 {
    color: var(--color-gray-600);
}

.text-danger {
    color: #d32f2f;
}

/* Modal Styles */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    animation: fadeIn 0.2s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal-content {
    background: white;
    border-radius: var(--radius-lg);
    width: 90%;
    max-width: 900px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        transform: translateY(-50px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.modal-header {
    padding: var(--space-4);
    border-bottom: 2px solid var(--color-gray-200);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, var(--color-primary) 0%, #0d0d0d 100%);
}

.modal-header h2 {
    margin: 0;
    color: white;
    font-size: var(--text-xl);
}

.modal-close {
    background: none;
    border: none;
    color: white;
    font-size: var(--text-xl);
    cursor: pointer;
    padding: var(--space-2);
    border-radius: var(--radius-sm);
    transition: all 0.2s;
}

.modal-close:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: rotate(90deg);
}

.modal-body {
    padding: var(--space-4);
}

.modal-footer {
    padding: var(--space-4);
    border-top: 1px solid var(--color-gray-200);
    display: flex;
    justify-content: flex-end;
    gap: var(--space-2);
    background: var(--color-gray-50);
}

.btn-outline {
    background: transparent;
    color: var(--color-primary);
    border: 2px solid var(--color-primary);
}

.btn-outline:hover {
    background: var(--color-primary);
    color: white;
}

@media (max-width: 768px) {
    .module-tabs {
        overflow-x: auto;
    }
    
    .tab-btn {
        white-space: nowrap;
    }
}
</style>

<script>
// Tabs functionality
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        // Remove active class from all
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        // Add active to clicked
        btn.classList.add('active');
        const tabId = btn.getAttribute('data-tab');
        document.getElementById(tabId + '-tab').classList.add('active');
    });
});

// Función para calcular "hace X días"
function getTimeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffTime = Math.abs(now - date);
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays === 0) return 'Hoy';
    if (diffDays === 1) return 'Hace 1 día';
    if (diffDays < 7) return `Hace ${diffDays} días`;
    const weeks = Math.floor(diffDays / 7);
    if (weeks === 1) return 'Hace 1 semana';
    if (weeks < 4) return `Hace ${weeks} semanas`;
    return 'Hace más de un mes';
}

// Cargar vacantes activas
async function loadVacancies() {
    const container = document.getElementById('vacanciesList');
    
    try {
        const response = await fetch('/api/vacancies');
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
            container.innerHTML = result.data.map(vacancy => `
                <div class="vacancy-item">
                    <div class="vacancy-header">
                        <h4>${vacancy.titulo}</h4>
                        <span class="badge badge-success">Activa</span>
                    </div>
                    <p class="vacancy-meta">
                        <i class="fas fa-building"></i> ${vacancy.departamento} &nbsp;|&nbsp;
                        <i class="fas fa-users"></i> ${vacancy.candidatos_count} candidato${vacancy.candidatos_count !== 1 ? 's' : ''} &nbsp;|&nbsp;
                        <i class="fas fa-clock"></i> ${getTimeAgo(vacancy.fecha_creacion)}
                    </p>
                    ${vacancy.salario ? `<p class="text-sm text-gray-600"><i class="fas fa-dollar-sign"></i> ${vacancy.salario}</p>` : ''}
                    <div class="vacancy-actions">
                        <button class="btn btn-sm btn-outline" onclick="viewCandidates(${vacancy.id})">Ver Candidatos</button>
                        <button class="btn btn-sm btn-outline" onclick="editVacancy(${vacancy.id})">Editar</button>
                    </div>
                </div>
            `).join('');
        } else {
            container.innerHTML = `
                <div class="text-center text-gray-600" style="padding: 2rem;">
                    <i class="fas fa-inbox" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                    <p>No hay vacantes activas en este momento</p>
                    <p class="text-sm">Publique una nueva vacante usando el formulario</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error cargando vacantes:', error);
        container.innerHTML = `
            <div class="text-center text-danger">
                <i class="fas fa-exclamation-circle"></i> Error al cargar las vacantes
            </div>
        `;
    }
}

// Función para cargar candidatos en la tabla principal
async function loadCandidates() {
    try {
        // Obtener candidatos y vacantes
        const [candidatesResponse, vacanciesResponse] = await Promise.all([
            fetch('/api/candidates'),
            fetch('/api/vacancies')
        ]);
        
        const candidatesResult = await candidatesResponse.json();
        const vacanciesResult = await vacanciesResponse.json();
        
        const candidatesTable = document.getElementById('candidatesTable');
        
        if (candidatesResult.success && candidatesResult.data && candidatesResult.data.length > 0) {
            const vacancies = vacanciesResult.success ? vacanciesResult.data : [];
            
            candidatesTable.innerHTML = candidatesResult.data.map(candidato => {
                // Buscar la vacante correspondiente
                const vacancy = vacancies.find(v => v.id === candidato.vacante_id);
                const cargoAplicado = vacancy ? vacancy.titulo : 'Cargo no especificado';
                
                return `
                    <tr>
                        <td><strong>${candidato.nombre}</strong></td>
                        <td>${cargoAplicado}</td>
                        <td>${candidato.email}</td>
                        <td>${candidato.telefono || 'No registrado'}</td>
                        <td>
                            <span class="badge ${getEstadoBadgeClass(candidato.estado)}">
                                ${getEstadoLabel(candidato.estado)}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline" onclick="verPerfilCandidato(${candidato.id}, '${candidato.nombre}', '${cargoAplicado}', '${candidato.email}', '${candidato.telefono || ''}', '${candidato.estado}')">
                                <i class="fas fa-user"></i> Ver Perfil
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // También llenar el select de candidatos para entrevistas
            const candidateSelect = document.getElementById('candidate');
            if (candidateSelect) {
                const currentValue = candidateSelect.value;
                candidateSelect.innerHTML = '<option value="">Seleccione un candidato...</option>' +
                    candidatesResult.data.map(c => 
                        `<option value="${c.id}">${c.nombre}</option>`
                    ).join('');
                if (currentValue) candidateSelect.value = currentValue;
            }
        } else {
            candidatesTable.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-user-slash" style="font-size: 2rem; opacity: 0.3; margin-bottom: 10px;"></i>
                        <p>No hay candidatos registrados</p>
                        <p style="font-size: 0.9rem; color: #999;">Los candidatos aparecerán aquí cuando se registren</p>
                    </td>
                </tr>
            `;
        }
    } catch (error) {
        console.error('Error cargando candidatos:', error);
        const candidatesTable = document.getElementById('candidatesTable');
        candidatesTable.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center; padding: 40px; color: #dc3545;">
                    <i class="fas fa-exclamation-circle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                    <p>Error al cargar candidatos</p>
                </td>
            </tr>
        `;
    }
}

// Placeholder functions
async function viewCandidates(vacancyId) {
    try {
        // Obtener información de la vacante
        const vacancyResponse = await fetch('/api/vacancies');
        const vacancyResult = await vacancyResponse.json();
        
        if (!vacancyResult.success || !vacancyResult.data) {
            alert('Error al cargar la vacante');
            return;
        }
        
        const vacancy = vacancyResult.data.find(v => v.id === vacancyId);
        
        if (!vacancy) {
            alert('No se encontró la vacante');
            return;
        }
        
        // Obtener candidatos
        const candidatesResponse = await fetch('/api/candidates');
        const candidatesResult = await candidatesResponse.json();
        
        // Filtrar candidatos de esta vacante
        const candidatos = candidatesResult.success && candidatesResult.data 
            ? candidatesResult.data.filter(c => c.vacante_id === vacancyId)
            : [];
        
        // Crear modal
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h2><i class="fas fa-users"></i> Candidatos para: ${vacancy.titulo}</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="modal-body">
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--color-gray-100); border-radius: var(--radius-md);">
                        <p style="margin: 0; color: var(--color-gray-700);">
                            <strong>Departamento:</strong> ${vacancy.departamento} &nbsp;|&nbsp;
                            <strong>Nivel:</strong> ${vacancy.nivel || 'N/A'} &nbsp;|&nbsp;
                            <strong>Vacantes:</strong> ${vacancy.cantidad}
                        </p>
                    </div>
                    
                    <h3 style="margin-bottom: 1rem; color: var(--color-primary);">
                        <i class="fas fa-user-check"></i> Candidatos Postulados (${candidatos.length})
                    </h3>
                    
                    ${candidatos.length > 0 ? `
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Email</th>
                                        <th>Teléfono</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${candidatos.map(candidato => `
                                        <tr>
                                            <td><strong>${candidato.nombre}</strong></td>
                                            <td>${candidato.email}</td>
                                            <td>${candidato.telefono || 'No registrado'}</td>
                                            <td>
                                                <span class="badge ${getEstadoBadgeClass(candidato.estado)}">
                                                    ${getEstadoLabel(candidato.estado)}
                                                </span>
                                            </td>
                                            <td>
                                                <button class="btn-icon" onclick="verPerfilCandidato(${candidato.id}, '${candidato.nombre}', '${vacancy.titulo}', '${candidato.email}', '${candidato.telefono || ''}', '${candidato.estado}')" title="Ver Perfil">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : `
                        <div class="text-center text-gray-600" style="padding: 3rem;">
                            <i class="fas fa-user-slash" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                            <p>No hay candidatos postulados para esta vacante</p>
                            <p class="text-sm">Los candidatos aparecerán aquí cuando se postulen</p>
                        </div>
                    `}
                    
                    ${vacancy.descripcion ? `
                    <div style="margin-top: 2rem;">
                        <h3 style="margin-bottom: 1rem; color: var(--color-primary);">
                            <i class="fas fa-file-alt"></i> Descripción del Cargo
                        </h3>
                        <p style="color: var(--color-gray-700); line-height: 1.6; padding: 1rem; background: var(--color-gray-100); border-radius: var(--radius-md);">
                            ${vacancy.descripcion}
                        </p>
                    </div>
                    ` : ''}
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                    <button class="btn" onclick="agregarCandidato(${vacancy.id})">
                        <i class="fas fa-user-plus"></i> Agregar Candidato
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Cerrar al hacer clic fuera del modal
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    } catch (error) {
        console.error('Error cargando candidatos:', error);
        alert('Error al cargar los candidatos de la vacante');
    }
}

async function editVacancy(vacancyId) {
    try {
        const response = await fetch('/api/vacancies');
        const result = await response.json();
        
        if (result.success && result.data) {
            const vacancy = result.data.find(v => v.id === vacancyId);
            
            if (!vacancy) {
                alert('No se encontró la vacante');
                return;
            }
            
            // Crear modal de edición
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h2><i class="fas fa-edit"></i> Editar Vacante</h2>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="modal-body">
                        <form id="editVacancyForm" class="form">
                            <input type="hidden" id="editVacancyId" value="${vacancy.id}">
                            
                            <div class="form-group">
                                <label for="editJobTitle">Título del Cargo</label>
                                <input type="text" id="editJobTitle" name="titulo" value="${vacancy.titulo}" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="editDepartment">Departamento</label>
                                <select id="editDepartment" name="departamento" required>
                                    <option value="tecnologia" ${vacancy.departamento === 'tecnologia' ? 'selected' : ''}>Tecnología</option>
                                    <option value="rrhh" ${vacancy.departamento === 'rrhh' ? 'selected' : ''}>Recursos Humanos</option>
                                    <option value="ventas" ${vacancy.departamento === 'ventas' ? 'selected' : ''}>Ventas</option>
                                    <option value="marketing" ${vacancy.departamento === 'marketing' ? 'selected' : ''}>Marketing</option>
                                    <option value="finanzas" ${vacancy.departamento === 'finanzas' ? 'selected' : ''}>Finanzas</option>
                                    <option value="operaciones" ${vacancy.departamento === 'operaciones' ? 'selected' : ''}>Operaciones</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="editLevel">Nivel del Cargo</label>
                                <select id="editLevel" name="nivel" required>
                                    <option value="junior" ${vacancy.nivel === 'junior' ? 'selected' : ''}>Junior</option>
                                    <option value="middle" ${vacancy.nivel === 'middle' ? 'selected' : ''}>Middle</option>
                                    <option value="senior" ${vacancy.nivel === 'senior' ? 'selected' : ''}>Senior</option>
                                    <option value="lead" ${vacancy.nivel === 'lead' ? 'selected' : ''}>Lead</option>
                                    <option value="manager" ${vacancy.nivel === 'manager' ? 'selected' : ''}>Manager</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="editPositions">Cantidad de Vacantes</label>
                                <input type="number" id="editPositions" name="cantidad" value="${vacancy.cantidad}" min="1" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="editDescription">Descripción del Cargo</label>
                                <textarea id="editDescription" name="descripcion" rows="4" required>${vacancy.descripcion || ''}</textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="editSalary">Rango Salarial</label>
                                <input type="text" id="editSalary" name="salario" value="${vacancy.salario || ''}">
                            </div>
                            
                            <div class="form-group">
                                <label for="editEstado">Estado</label>
                                <select id="editEstado" name="estado">
                                    <option value="activa" ${vacancy.estado === 'activa' ? 'selected' : ''}>Activa</option>
                                    <option value="pausada" ${vacancy.estado === 'pausada' ? 'selected' : ''}>Pausada</option>
                                    <option value="cerrada" ${vacancy.estado === 'cerrada' ? 'selected' : ''}>Cerrada</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    
                    <div class="modal-footer">
                        <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button class="btn" onclick="guardarEdicionVacante()">
                            <i class="fas fa-save"></i> Guardar Cambios
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Cerrar al hacer clic fuera del modal
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
    } catch (error) {
        console.error('Error cargando vacante:', error);
        alert('Error al cargar la vacante para edición');
    }
}

async function guardarEdicionVacante() {
    const form = document.getElementById('editVacancyForm');
    const vacancyId = document.getElementById('editVacancyId').value;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    data.cantidad = parseInt(data.cantidad) || 1;
    
    const submitBtn = event.target;
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
    
    try {
        const response = await fetch(`/api/vacancies/${vacancyId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            alert('✓ Vacante actualizada exitosamente');
            document.querySelector('.modal-overlay')?.remove();
            loadVacancies();
        } else {
            alert('Error: ' + (result.message || 'No se pudo actualizar la vacante'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al actualizar la vacante. Por favor, intente nuevamente.');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
}

function agregarCandidato(vacancyId) {
    alert('Función para agregar candidato en desarrollo.\nVacante ID: ' + vacancyId);
    // Aquí se implementaría el formulario para agregar un nuevo candidato
}

// Ver perfil de candidato
function verPerfilCandidato(id, nombre, cargo, email, telefono, estado) {
    // Crear modal con perfil del candidato
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    
    // Datos de ejemplo para demostración
    const candidatoData = {
        id: id,
        nombre: nombre,
        cargo: cargo,
        email: email,
        telefono: telefono,
        estado: estado,
        // Datos adicionales de ejemplo
        experiencia: '5 años',
        educacion: 'Ingeniería de Sistemas - Universidad Nacional',
        habilidades: ['JavaScript', 'Python', 'React', 'Node.js', 'SQL', 'Git'],
        idiomas: ['Español (Nativo)', 'Inglés (B2)'],
        disponibilidad: 'Inmediata',
        salarioEsperado: '$4.500.000',
        fechaAplicacion: '5 de noviembre, 2025',
        cv: 'curriculum_' + nombre.toLowerCase().replace(/ /g, '_') + '.pdf'
    };
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2><i class="fas fa-user-circle"></i> Perfil del Candidato</h2>
                <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <!-- Información Personal -->
                <div style="margin-bottom: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;">
                        <div>
                            <h3 style="margin: 0 0 0.5rem; font-size: 1.5rem; color: var(--color-primary);">
                                ${candidatoData.nombre}
                            </h3>
                            <p style="margin: 0; color: var(--color-gray-600); font-size: 1.1rem;">
                                <i class="fas fa-briefcase"></i> ${candidatoData.cargo}
                            </p>
                        </div>
                        <span class="badge ${getEstadoBadgeClass(candidatoData.estado)}">
                            ${getEstadoLabel(candidatoData.estado)}
                        </span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; padding: 1rem; background: var(--color-gray-100); border-radius: var(--radius-md);">
                        <div>
                            <i class="fas fa-envelope" style="color: var(--color-accent);"></i>
                            <strong>Email:</strong> ${candidatoData.email}
                        </div>
                        <div>
                            <i class="fas fa-phone" style="color: var(--color-accent);"></i>
                            <strong>Teléfono:</strong> ${candidatoData.telefono}
                        </div>
                        <div>
                            <i class="fas fa-calendar-alt" style="color: var(--color-accent);"></i>
                            <strong>Fecha de Aplicación:</strong> ${candidatoData.fechaAplicacion}
                        </div>
                        <div>
                            <i class="fas fa-clock" style="color: var(--color-accent);"></i>
                            <strong>Disponibilidad:</strong> ${candidatoData.disponibilidad}
                        </div>
                    </div>
                </div>
                
                <!-- Experiencia y Educación -->
                <div style="margin-bottom: 2rem;">
                    <h3 style="color: var(--color-accent); margin-bottom: 1rem; border-bottom: 2px solid var(--color-accent); padding-bottom: 0.5rem;">
                        <i class="fas fa-graduation-cap"></i> Formación y Experiencia
                    </h3>
                    <div style="display: grid; gap: 1rem;">
                        <div style="padding: 1rem; background: var(--color-gray-50); border-radius: var(--radius-md);">
                            <strong style="color: var(--color-primary);"><i class="fas fa-briefcase"></i> Experiencia:</strong>
                            <p style="margin: 0.5rem 0 0;">${candidatoData.experiencia} de experiencia profesional</p>
                        </div>
                        <div style="padding: 1rem; background: var(--color-gray-50); border-radius: var(--radius-md);">
                            <strong style="color: var(--color-primary);"><i class="fas fa-university"></i> Educación:</strong>
                            <p style="margin: 0.5rem 0 0;">${candidatoData.educacion}</p>
                        </div>
                    </div>
                </div>
                
                <!-- Habilidades -->
                <div style="margin-bottom: 2rem;">
                    <h3 style="color: var(--color-accent); margin-bottom: 1rem; border-bottom: 2px solid var(--color-accent); padding-bottom: 0.5rem;">
                        <i class="fas fa-code"></i> Habilidades Técnicas
                    </h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        ${candidatoData.habilidades.map(skill => `
                            <span style="padding: 0.5rem 1rem; background: var(--color-accent); color: white; border-radius: var(--radius-sm); font-size: 0.875rem;">
                                ${skill}
                            </span>
                        `).join('')}
                    </div>
                </div>
                
                <!-- Idiomas y Salario -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
                    <div>
                        <h3 style="color: var(--color-accent); margin-bottom: 1rem; border-bottom: 2px solid var(--color-accent); padding-bottom: 0.5rem;">
                            <i class="fas fa-language"></i> Idiomas
                        </h3>
                        <ul style="list-style: none; padding: 0; margin: 0;">
                            ${candidatoData.idiomas.map(idioma => `
                                <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--color-gray-200);">
                                    <i class="fas fa-check-circle" style="color: var(--color-success);"></i> ${idioma}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    <div>
                        <h3 style="color: var(--color-accent); margin-bottom: 1rem; border-bottom: 2px solid var(--color-accent); padding-bottom: 0.5rem;">
                            <i class="fas fa-dollar-sign"></i> Aspiración Salarial
                        </h3>
                        <p style="font-size: 1.5rem; font-weight: bold; color: var(--color-accent); margin: 1rem 0;">
                            ${candidatoData.salarioEsperado}
                        </p>
                    </div>
                </div>
                
                <!-- CV -->
                <div style="padding: 1rem; background: var(--color-gray-100); border-radius: var(--radius-md); display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <i class="fas fa-file-pdf" style="font-size: 2rem; color: #d32f2f; margin-right: 1rem;"></i>
                        <strong>Currículum Vitae:</strong> ${candidatoData.cv}
                    </div>
                    <button class="btn btn-sm" onclick="descargarCV('${candidatoData.cv}')">
                        <i class="fas fa-download"></i> Descargar CV
                    </button>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">
                    <i class="fas fa-times"></i> Cerrar
                </button>
                <button class="btn" onclick="agendarEntrevista(${candidatoData.id}, '${candidatoData.nombre}')">
                    <i class="fas fa-calendar-check"></i> Agendar Entrevista
                </button>
                <button class="btn" style="background: var(--color-success);" onclick="contratarCandidato(${candidatoData.id}, '${candidatoData.nombre}')">
                    <i class="fas fa-user-check"></i> Contratar
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Cerrar al hacer clic fuera del modal
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

function getEstadoBadgeClass(estado) {
    const badges = {
        'en_proceso': 'badge-info',
        'entrevista': 'badge-warning',
        'contratado': 'badge-success',
        'rechazado': 'badge-danger'
    };
    return badges[estado] || 'badge-info';
}

function getEstadoLabel(estado) {
    const labels = {
        'en_proceso': 'En Proceso',
        'entrevista': 'Entrevista',
        'contratado': 'Contratado',
        'rechazado': 'Rechazado'
    };
    return labels[estado] || estado;
}

function descargarCV(filename) {
    alert('Descargando CV: ' + filename + '\n\nEsta funcionalidad descargará el currículum del candidato.');
}

function agendarEntrevista(candidatoId, candidatoNombre) {
    // Cerrar modal anterior
    document.querySelector('.modal-overlay')?.remove();
    
    // Crear modal para agendar entrevista
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.display = 'flex';
    
    // Obtener fecha y hora actual para valores por defecto
    const now = new Date();
    const fechaMin = now.toISOString().split('T')[0];
    const horaActual = now.toTimeString().slice(0, 5);
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px; animation: slideDown 0.3s ease;">
            <div class="modal-header">
                <h2 style="margin: 0; font-size: 1.5rem;">
                    <i class="fas fa-calendar-check" style="color: #c49b63; margin-right: 10px;"></i>
                    Agendar Entrevista
                </h2>
                <button class="close-modal" onclick="this.closest('.modal-overlay').remove()" 
                        style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <form id="entrevistaForm" style="display: grid; gap: 20px;">
                    <input type="hidden" name="candidato_id" value="${candidatoId}">
                    <input type="hidden" name="estado" value="programada">
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">
                            <i class="fas fa-user" style="color: #c49b63; margin-right: 5px;"></i>
                            Candidato
                        </label>
                        <input type="text" value="${candidatoNombre}" readonly 
                               style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background: #f5f5f5;">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">
                                <i class="fas fa-calendar" style="color: #c49b63; margin-right: 5px;"></i>
                                Fecha <span style="color: red;">*</span>
                            </label>
                            <input type="date" name="fecha" required min="${fechaMin}"
                                   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">
                                <i class="fas fa-clock" style="color: #c49b63; margin-right: 5px;"></i>
                                Hora <span style="color: red;">*</span>
                            </label>
                            <input type="time" name="hora" required value="${horaActual}"
                                   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">
                            <i class="fas fa-list" style="color: #c49b63; margin-right: 5px;"></i>
                            Tipo de Entrevista <span style="color: red;">*</span>
                        </label>
                        <select name="tipo" required 
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            <option value="">Seleccione...</option>
                            <option value="telefonica">Telefónica</option>
                            <option value="presencial" selected>Presencial</option>
                            <option value="virtual">Virtual</option>
                            <option value="tecnica">Técnica</option>
                        </select>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">
                            <i class="fas fa-user-tie" style="color: #c49b63; margin-right: 5px;"></i>
                            Entrevistador <span style="color: red;">*</span>
                        </label>
                        <input type="text" name="entrevistador" required 
                               placeholder="Nombre del entrevistador"
                               style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">
                            <i class="fas fa-comment-dots" style="color: #c49b63; margin-right: 5px;"></i>
                            Observaciones
                        </label>
                        <textarea name="comentarios" rows="3" 
                                  placeholder="Notas adicionales sobre la entrevista..."
                                  style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical; font-family: inherit;"></textarea>
                    </div>
                </form>
            </div>
            
            <div class="modal-footer" style="display: flex; gap: 10px; justify-content: flex-end; padding: 20px; border-top: 1px solid #eee;">
                <button type="button" onclick="this.closest('.modal-overlay').remove()" 
                        style="padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 5px; cursor: pointer;">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="submit" form="entrevistaForm"
                        style="padding: 10px 20px; border: none; background: #c49b63; color: white; border-radius: 5px; cursor: pointer; font-weight: 500;">
                    <i class="fas fa-calendar-check"></i> Agendar Entrevista
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Handler para el formulario
    document.getElementById('entrevistaForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        e.stopImmediatePropagation();
        
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        
        // Convertir candidato_id a número
        data.candidato_id = parseInt(data.candidato_id);
        
        try {
            const response = await fetch('/api/interviews', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert('✅ Entrevista agendada exitosamente!\n\n' +
                      'Candidato: ' + candidatoNombre + '\n' +
                      'Fecha: ' + new Date(data.fecha).toLocaleDateString('es-CO') + '\n' +
                      'Hora: ' + data.hora + '\n' +
                      'Tipo: ' + data.tipo.charAt(0).toUpperCase() + data.tipo.slice(1) + '\n' +
                      'Entrevistador: ' + data.entrevistador);
                
                modal.remove();
                
                // Opcional: Cambiar a la pestaña de entrevistas
                // document.querySelector('[data-tab="entrevistas"]')?.click();
                
            } else {
                alert('❌ Error al agendar entrevista:\n\n' + result.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('❌ Error de conexión. Por favor intente nuevamente.');
        }
    });
    
    // Enfocar el primer campo
    setTimeout(() => {
        modal.querySelector('input[name="fecha"]').focus();
    }, 100);
}

function contratarCandidato(candidatoId, candidatoNombre) {
    if (confirm('¿Está seguro de que desea contratar a ' + candidatoNombre + '?\n\nEsto creará automáticamente el registro del empleado en el sistema.')) {
        // Obtener datos del candidato desde el modal
        const modal = document.querySelector('.modal-overlay');
        
        // Datos del candidato a contratar
        const candidatoData = {
            nombre: candidatoNombre,
            identificacion: '1000000' + candidatoId, // Temporal - debería venir del sistema
            email: candidatoId === 1 ? 'ana.garcia@email.com' : 'carlos.r@email.com',
            telefono: candidatoId === 1 ? '+57 300 123 4567' : '+57 301 234 5678',
            cargo: candidatoId === 1 ? 'Desarrollador Full Stack Senior' : 'Desarrollador Full Stack Senior',
            departamento: 'tecnologia',
            salario: 4500000, // Debería venir de la aspiración salarial
            fecha_ingreso: new Date().toISOString().split('T')[0] // Fecha de hoy
        };
        
        let empleadoCreado = null;
        
        // Paso 1: Crear empleado
        fetch('/api/employees', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(candidatoData)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                empleadoCreado = result.data;
                
                // Paso 2: Crear contrato automáticamente
                const contratoData = {
                    empleado_id: result.data.id,
                    cargo: candidatoData.cargo,
                    tipo: 'Indefinido',
                    fecha_inicio: candidatoData.fecha_ingreso,
                    salario: candidatoData.salario,
                    departamento: candidatoData.departamento,
                    jornada: 'Tiempo completo'
                };
                
                return fetch('/api/contracts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(contratoData)
                });
            } else {
                throw new Error(result.message || 'Error al crear empleado');
            }
        })
        .then(response => response.json())
        .then(contratoResult => {
            if (contratoResult.success) {
                // Paso 3: Actualizar estado del candidato a "contratado"
                return fetch(`/api/candidates/${candidatoId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        estado: 'contratado',
                        notas: `Contratado el ${new Date().toLocaleDateString('es-CO')}. ID Empleado: ${empleadoCreado.id}`
                    })
                });
            } else {
                // Si falla el contrato, aún mostrar mensaje
                throw new Error('Error al crear el contrato');
            }
        })
        .then(response => response.json())
        .then(candidatoResult => {
            // Éxito completo
            alert('✅ ¡Contratación exitosa!\n\n' + 
                  '✓ Empleado creado en el sistema\n' +
                  '✓ Contrato generado automáticamente\n' +
                  '✓ Candidato marcado como contratado\n\n' +
                  candidatoNombre + ' ahora aparece en la lista de empleados.\n' +
                  'El candidato ya no aparecerá en la lista de candidatos activos.');
            
            // Cerrar modal
            document.querySelector('.modal-overlay')?.remove();
            
            // Actualizar la vista (en una implementación real, recargaría la tabla de candidatos)
            // Para este ejemplo, podríamos ocultar la fila del candidato contratado
            
        })
        .catch(error => {
            console.error('Error:', error);
            
            if (empleadoCreado) {
                // Si el empleado se creó pero falló algo después
                alert('⚠️ Atención:\n\n' + 
                      '✓ Empleado creado exitosamente (ID: ' + empleadoCreado.id + ')\n' +
                      '✗ Error en proceso posterior: ' + error.message + '\n\n' +
                      'Por favor, complete manualmente el proceso desde el módulo de Contratación.');
            } else {
                // Falló completamente
                alert('❌ Error en el proceso de contratación:\n\n' + 
                      error.message + '\n\n' +
                      'Por favor, intente nuevamente.');
            }
        });
    }
}

// Form submission
document.getElementById('newVacancyForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    
    // Convertir cantidad a número
    data.cantidad = parseInt(data.cantidad) || 1;
    
    try {
        const response = await fetch('/api/vacancies', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            window.ConexaApp.showSuccessMessage(e.target, '¡Vacante publicada exitosamente!');
            e.target.reset();
            // Recargar la lista de vacantes
            loadVacancies();
        } else {
            alert('Error: ' + (result.message || 'No se pudo publicar la vacante'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al publicar la vacante. Por favor, intente nuevamente.');
    }
});

// Handler para el formulario de agendar entrevista
document.getElementById('scheduleInterviewForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    e.stopImmediatePropagation();
    
    const formData = new FormData(e.target);
    const candidatoId = formData.get('candidate');
    const fecha = formData.get('interviewDate');
    const hora = formData.get('interviewTime');
    const entrevistador = formData.get('interviewer');
    
    if (!candidatoId || !fecha || !hora) {
        alert('⚠️ Por favor complete todos los campos requeridos');
        return;
    }
    
    const data = {
        candidato_id: parseInt(candidatoId),
        fecha: fecha,
        hora: hora,
        tipo: 'presencial',
        entrevistador: entrevistador || 'Sin asignar',
        estado: 'programada'
    };
    
    try {
        const response = await fetch('/api/interviews', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('✅ Entrevista agendada exitosamente!');
            e.target.reset();
            // Recargar la lista de entrevistas
            loadInterviews();
        } else {
            alert('❌ Error: ' + (result.message || 'No se pudo agendar la entrevista'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('❌ Error de conexión. Por favor intente nuevamente.');
    }
});

// Función para cargar entrevistas
async function loadInterviews() {
    try {
        const response = await fetch('/api/interviews');
        const result = await response.json();
        
        if (result.success && result.data) {
            const interviewsList = document.getElementById('interviews-list');
            
            // Filtrar solo entrevistas programadas o pendientes
            const upcomingInterviews = result.data.filter(e => e.estado === 'programada');
            
            if (upcomingInterviews.length === 0) {
                interviewsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-calendar-alt" style="font-size: 3rem; color: #ddd; margin-bottom: 15px;"></i>
                        <p>No hay entrevistas programadas</p>
                        <p style="font-size: 0.9rem; color: #999;">Las entrevistas agendadas aparecerán aquí</p>
                    </div>
                `;
                return;
            }
            
            // Ordenar por fecha y hora
            upcomingInterviews.sort((a, b) => {
                const dateA = new Date(a.fecha + 'T' + a.hora);
                const dateB = new Date(b.fecha + 'T' + b.hora);
                return dateA - dateB;
            });
            
            // Renderizar entrevistas
            interviewsList.innerHTML = upcomingInterviews.map(entrevista => {
                const fecha = new Date(entrevista.fecha);
                const dia = fecha.getDate();
                const mes = fecha.toLocaleDateString('es-CO', { month: 'short' }).toUpperCase();
                
                // Formatear hora (de "HH:MM:SS" a "HH:MM AM/PM")
                const [hours, minutes] = entrevista.hora.split(':');
                const hour = parseInt(hours);
                const ampm = hour >= 12 ? 'PM' : 'AM';
                const hour12 = hour % 12 || 12;
                const horaFormateada = `${hour12}:${minutes} ${ampm}`;
                
                return `
                    <div class="interview-item">
                        <div class="interview-date">
                            <div class="date-day">${dia}</div>
                            <div class="date-month">${mes}</div>
                        </div>
                        <div class="interview-info">
                            <h4>${entrevista.candidato_nombre}</h4>
                            <p>${entrevista.tipo ? entrevista.tipo.charAt(0).toUpperCase() + entrevista.tipo.slice(1) : 'Entrevista'}</p>
                            <p class="text-sm">
                                <i class="fas fa-clock"></i> ${horaFormateada}
                                ${entrevista.entrevistador ? ` | <i class="fas fa-user"></i> ${entrevista.entrevistador}` : ''}
                            </p>
                        </div>
                    </div>
                `;
            }).join('');
        }
    } catch (error) {
        console.error('Error al cargar entrevistas:', error);
        document.getElementById('interviews-list').innerHTML = `
            <div style="text-align: center; padding: 40px; color: #999;">
                <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: #ddd; margin-bottom: 15px;"></i>
                <p>Error al cargar entrevistas</p>
            </div>
        `;
    }
}

// Cargar vacantes cuando se carga la página
document.addEventListener('DOMContentLoaded', () => {
    loadVacancies();
    loadCandidates();
    loadInterviews();
});
</script>

{% endblock %}