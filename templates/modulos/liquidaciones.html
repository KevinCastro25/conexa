{% extends "base.html" %}
{% block content %}

<div class="module-header-with-image">
    <div class="module-header-bg">
        <img src="{{ url_for('static', filename='images/FINANZAS.jpg') }}" alt="Liquidaciones">
        <div class="module-header-overlay"></div>
    </div>
    <div class="container">
        <div class="module-header-content">
            <p class="text-uppercase text-accent mb-2">Módulo de Nómina</p>
            <h1>Gestión de Liquidaciones</h1>
            <p class="module-description">Cálculo preciso de nómina, prestaciones sociales, liquidaciones y generación automática de reportes financieros.</p>
        </div>
    </div>
</div>

<div class="container section"
    
    <div class="grid">
        <!-- Nueva Liquidación -->
        <div class="card">
            <h2><i class="fas fa-calculator"></i> Nueva Liquidación</h2>
            <form id="newLiquidationForm" class="form">
                <div class="form-group">
                    <label for="employeeLiquidation">Empleado *</label>
                    <select id="employeeLiquidation" name="empleado_id" required>
                        <option value="">Seleccione un empleado...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="liquidationType">Tipo de Liquidación *</label>
                    <select id="liquidationType" name="tipo" required>
                        <option value="">Seleccione...</option>
                        <option value="nomina">Nómina Mensual</option>
                        <option value="prima">Prima</option>
                        <option value="cesantias">Cesantías</option>
                        <option value="vacaciones">Vacaciones</option>
                        <option value="definitiva">Liquidación Definitiva</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="periodStart">Periodo Desde *</label>
                    <input type="date" id="periodStart" name="periodo_inicio" required>
                </div>
                <div class="form-group">
                    <label for="periodEnd">Periodo Hasta *</label>
                    <input type="date" id="periodEnd" name="periodo_fin" required>
                </div>
                <div class="form-group">
                    <label for="baseSalary">Salario Base *</label>
                    <input type="number" id="baseSalary" name="salario_base" required placeholder="Ej: 3000000">
                </div>
                <button type="submit" class="btn">Calcular Liquidación</button>
            </form>
        </div>

        <!-- Historial de Liquidaciones -->
        <div class="card">
            <h2><i class="fas fa-history"></i> Historial de Liquidaciones</h2>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Empleado</th>
                            <th>Tipo</th>
                            <th>Periodo</th>
                            <th>Valor</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="liquidationsHistoryTable">
                        <!-- Se llenará dinámicamente -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Resumen de Nómina -->
        <div class="card">
            <h2><i class="fas fa-chart-pie"></i> Resumen de Nómina Actual</h2>
            <div class="summary-stats">
                <div class="stat-item">
                    <label>Total Empleados:</label>
                    <span id="totalEmployees">0</span>
                </div>
                <div class="stat-item">
                    <label>Total Nómina:</label>
                    <span id="totalPayroll">$0</span>
                </div>
                <div class="stat-item">
                    <label>Provisiones:</label>
                    <span id="totalProvisions">$0</span>
                </div>
            </div>
            <div id="payrollChart" class="chart-container">
                <!-- Aquí se insertará el gráfico -->
            </div>
        </div>
    </div>
</div>

<style>
.module-header-with-image {
    position: relative;
    padding: 120px 0 80px;
    min-height: 400px;
    display: flex;
    align-items: center;
    overflow: hidden;
}

.module-header-bg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
}

.module-header-bg img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
}

.module-header-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, rgba(26, 26, 26, 0.85) 0%, rgba(26, 26, 26, 0.65) 100%);
}

.module-header-with-image .container {
    position: relative;
    z-index: 1;
}

.module-header-content {
    max-width: 700px;
}

.module-header-content h1,
.module-header-content p,
.module-header-content .text-uppercase {
    color: white;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.module-description {
    max-width: 700px;
    font-size: var(--text-lg);
    color: rgba(255, 255, 255, 0.9);
    margin: 0;
}

.summary-stats {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    margin-bottom: var(--space-4);
}

.stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-3);
    background: var(--color-gray-100);
    border-radius: var(--radius-md);
}

.stat-item label {
    font-weight: 600;
    color: var(--color-primary);
}

.stat-item span {
    font-size: var(--text-lg);
    font-weight: 700;
    color: var(--color-accent);
}

.text-center {
    text-align: center;
}

.text-gray-600 {
    color: var(--color-gray-600);
}

.text-danger {
    color: #d32f2f;
}

.text-right {
    text-align: right;
}

.badge {
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-sm);
    font-size: var(--text-xs);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.badge-success {
    background: rgba(46, 125, 50, 0.1);
    color: var(--color-success);
}

.badge-warning {
    background: rgba(245, 124, 0, 0.1);
    color: var(--color-warning);
}

/* Modal Styles */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal-content {
    background: white;
    border-radius: var(--radius-lg);
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: slideUp 0.3s ease;
}

.modal-large {
    max-width: 700px;
}

@keyframes slideUp {
    from { 
        opacity: 0;
        transform: translateY(30px);
    }
    to { 
        opacity: 1;
        transform: translateY(0);
    }
}

.modal-header {
    padding: var(--space-6);
    border-bottom: 1px solid var(--color-gray-200);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, var(--color-primary) 0%, #0d0d0d 100%);
    color: white;
}

.modal-header h3 {
    margin: 0;
    font-size: var(--text-xl);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.modal-close {
    background: none;
    border: none;
    color: white;
    font-size: 2rem;
    cursor: pointer;
    line-height: 1;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0.8;
    transition: opacity var(--transition-base);
}

.modal-close:hover {
    opacity: 1;
}

.modal-body {
    padding: var(--space-6);
    overflow-y: auto;
    flex: 1;
}

.modal-footer {
    padding: var(--space-4) var(--space-6);
    border-top: 1px solid var(--color-gray-200);
    display: flex;
    justify-content: flex-end;
    gap: var(--space-2);
}

/* Liquidation Detail Styles */
.liquidation-info {
    margin-bottom: var(--space-6);
    padding: var(--space-4);
    background: var(--color-gray-100);
    border-radius: var(--radius-md);
}

.info-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-4);
    margin-bottom: var(--space-3);
}

.info-row:last-child {
    margin-bottom: 0;
}

.info-item {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
}

.info-item label {
    font-size: var(--text-sm);
    color: var(--color-gray-600);
    font-weight: 600;
}

.liquidation-breakdown {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
}

.breakdown-section {
    border: 1px solid var(--color-gray-200);
    border-radius: var(--radius-md);
    padding: var(--space-4);
}

.breakdown-section h4 {
    margin: 0 0 var(--space-3);
    font-size: var(--text-lg);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.text-success {
    color: var(--color-success);
}

.text-danger {
    color: #d32f2f;
}

.breakdown-items {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    margin-bottom: var(--space-3);
}

.breakdown-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-2) 0;
    border-bottom: 1px dashed var(--color-gray-200);
}

.breakdown-item:last-child {
    border-bottom: none;
}

.breakdown-total {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-3);
    border-radius: var(--radius-sm);
    font-size: var(--text-lg);
    font-weight: 700;
}

.breakdown-total.success {
    background: rgba(46, 125, 50, 0.1);
    color: var(--color-success);
}

.breakdown-total.danger {
    background: rgba(211, 47, 47, 0.1);
    color: #d32f2f;
}

.breakdown-total.primary {
    background: linear-gradient(135deg, var(--color-accent) 0%, #a67c52 100%);
    color: white;
    font-size: var(--text-2xl);
    padding: var(--space-4);
}

.neto-section {
    border: 2px solid var(--color-accent);
}

.neto-amount {
    font-size: 2rem;
}

.payment-info {
    margin-top: var(--space-4);
    padding: var(--space-3);
    background: rgba(46, 125, 50, 0.1);
    border-left: 4px solid var(--color-success);
    border-radius: var(--radius-sm);
    color: var(--color-success);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}
</style>

<script>
// Función para cargar empleados
async function loadEmployees() {
    try {
        const response = await fetch('/api/employees');
        const result = await response.json();
        
        if (result.success && result.data) {
            const employees = result.data;
            const employeeSelect = document.getElementById('employeeLiquidation');
            
            const options = employees.map(emp => 
                `<option value="${emp.id}">${emp.nombre} - ${emp.cargo || 'Sin cargo'} - $${emp.salario ? emp.salario.toLocaleString() : '0'}</option>`
            ).join('');
            
            employeeSelect.innerHTML = '<option value="">Seleccione un empleado...</option>' + options;
            
            console.log(`✓ ${employees.length} empleados cargados`);
        }
    } catch (error) {
        console.error('Error cargando empleados:', error);
    }
}

// Función para cargar liquidaciones
async function loadLiquidations() {
    const tbody = document.getElementById('liquidationsHistoryTable');
    
    try {
        const response = await fetch('/api/liquidations');
        const result = await response.json();
        
        if (result.success && result.data) {
            const liquidations = result.data;
            
            if (liquidations.length > 0) {
                tbody.innerHTML = liquidations.map(liq => `
                    <tr>
                        <td><strong>${liq.empleado_nombre || 'N/A'}</strong></td>
                        <td>${getTipoLabel(liq.tipo)}</td>
                        <td>${liq.periodo || formatPeriod(liq.periodo_inicio, liq.periodo_fin)}</td>
                        <td class="text-right"><strong>$${liq.neto ? liq.neto.toLocaleString() : '0'}</strong></td>
                        <td><span class="badge ${liq.estado === 'pagado' ? 'badge-success' : 'badge-warning'}">${liq.estado}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline" onclick="verDetalleLiquidacion(${liq.id})">Ver Detalle</button>
                        </td>
                    </tr>
                `).join('');
                
                // Actualizar resumen
                updatePayrollSummary(liquidations);
            } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-gray-600">
                            No hay liquidaciones registradas
                        </td>
                    </tr>
                `;
                // Resetear resumen
                updatePayrollSummary([]);
            }
        }
    } catch (error) {
        console.error('Error cargando liquidaciones:', error);
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-danger">
                    Error al cargar liquidaciones
                </td>
            </tr>
        `;
    }
}

// Función para actualizar el resumen de nómina
async function updatePayrollSummary(liquidations) {
    try {
        // Obtener empleados activos
        const empResponse = await fetch('/api/employees');
        const empResult = await empResponse.json();
        const totalEmployees = empResult.success ? empResult.data.length : 0;
        
        // Filtrar liquidaciones del mes actual
        const currentDate = new Date();
        const currentMonth = currentDate.getMonth() + 1;
        const currentYear = currentDate.getFullYear();
        
        const currentMonthLiquidations = liquidations.filter(liq => {
            if (!liq.periodo_inicio) return false;
            const liqDate = new Date(liq.periodo_inicio);
            return liqDate.getMonth() + 1 === currentMonth && 
                   liqDate.getFullYear() === currentYear;
        });
        
        // Calcular totales
        let totalPayroll = 0;
        let totalProvisions = 0;
        
        currentMonthLiquidations.forEach(liq => {
            if (liq.tipo === 'nomina') {
                totalPayroll += liq.neto || 0;
            } else {
                totalProvisions += liq.neto || 0;
            }
        });
        
        // Actualizar el DOM
        document.getElementById('totalEmployees').textContent = totalEmployees;
        document.getElementById('totalPayroll').textContent = '$' + totalPayroll.toLocaleString();
        document.getElementById('totalProvisions').textContent = '$' + totalProvisions.toLocaleString();
        
    } catch (error) {
        console.error('Error actualizando resumen:', error);
    }
}

// Función para obtener salario del empleado
async function getEmployeeSalary(employeeId) {
    try {
        const response = await fetch('/api/employees');
        const result = await response.json();
        
        if (result.success && result.data) {
            const employee = result.data.find(emp => emp.id == employeeId);
            return employee ? employee.salario : 0;
        }
    } catch (error) {
        console.error('Error obteniendo salario:', error);
    }
    return 0;
}

// Cuando se selecciona un empleado, cargar su salario automáticamente
document.getElementById('employeeLiquidation')?.addEventListener('change', async (e) => {
    const employeeId = e.target.value;
    if (employeeId) {
        const salary = await getEmployeeSalary(employeeId);
        const salaryInput = document.getElementById('baseSalary');
        if (salaryInput && salary) {
            salaryInput.value = salary;
        }
    }
});

// Manejo del formulario de nueva liquidación
document.getElementById('newLiquidationForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    e.stopImmediatePropagation();
    
    const formData = new FormData(e.target);
    const data = {};
    
    formData.forEach((value, key) => {
        data[key] = value;
    });
    
    // Convertir valores numéricos
    data.empleado_id = parseInt(data.empleado_id);
    data.salario_base = parseFloat(data.salario_base);
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculando...';
    
    try {
        const response = await fetch('/api/liquidations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            if (window.ConexaApp && window.ConexaApp.showSuccessMessage) {
                window.ConexaApp.showSuccessMessage(e.target, '✓ Liquidación calculada exitosamente');
            } else {
                alert('✓ Liquidación calculada exitosamente');
            }
            e.target.reset();
            loadLiquidations();
        } else {
            alert('Error: ' + (result.message || 'No se pudo crear la liquidación'));
        }
    } catch (error) {
        console.error('Error creando liquidación:', error);
        alert('Error al crear la liquidación. Por favor, intente nuevamente.');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
}, true);

// Funciones auxiliares
function getTipoLabel(tipo) {
    const labels = {
        'nomina': 'Nómina Mensual',
        'prima': 'Prima',
        'cesantias': 'Cesantías',
        'vacaciones': 'Vacaciones',
        'definitiva': 'Liquidación Definitiva'
    };
    return labels[tipo] || tipo;
}

function formatPeriod(inicio, fin) {
    if (!inicio || !fin) return 'N/A';
    const start = new Date(inicio);
    const end = new Date(fin);
    return `${start.toLocaleDateString('es-CO', { month: 'short', year: 'numeric' })} - ${end.toLocaleDateString('es-CO', { month: 'short', year: 'numeric' })}`;
}

function verDetalleLiquidacion(id) {
    // Buscar la liquidación en los datos cargados
    fetch('/api/liquidations')
        .then(response => response.json())
        .then(result => {
            if (result.success && result.data) {
                const liquidacion = result.data.find(l => l.id === id);
                
                if (liquidacion) {
                    mostrarModalDetalle(liquidacion);
                } else {
                    alert('No se encontró la liquidación');
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cargar el detalle');
        });
}

function mostrarModalDetalle(liq) {
    const devengado = liq.devengado || 0;
    const deducciones = liq.deducciones || 0;
    const neto = liq.neto || 0;
    const salarioBase = liq.salario_base || 0;
    
    // Calcular desglose aproximado de deducciones
    const deduccionSalud = salarioBase * 0.04;
    const deduccionPension = salarioBase * 0.04;
    const otrasDeducciones = deducciones - deduccionSalud - deduccionPension;
    
    const modalContent = `
        <div class="modal-overlay" id="modalDetalleLiquidacion" onclick="cerrarModalLiquidacion()">
            <div class="modal-content modal-large" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h3><i class="fas fa-file-invoice-dollar"></i> Detalle de Liquidación #${liq.id}</h3>
                    <button class="modal-close" onclick="cerrarModalLiquidacion()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="liquidation-info">
                        <div class="info-row">
                            <div class="info-item">
                                <label>Empleado:</label>
                                <strong>${liq.empleado_nombre || 'N/A'}</strong>
                            </div>
                            <div class="info-item">
                                <label>Tipo:</label>
                                <strong>${getTipoLabel(liq.tipo)}</strong>
                            </div>
                        </div>
                        <div class="info-row">
                            <div class="info-item">
                                <label>Periodo:</label>
                                <strong>${formatPeriod(liq.periodo_inicio, liq.periodo_fin)}</strong>
                            </div>
                            <div class="info-item">
                                <label>Estado:</label>
                                <span class="badge ${liq.estado === 'pagado' ? 'badge-success' : 'badge-warning'}">${liq.estado}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="liquidation-breakdown">
                        <div class="breakdown-section">
                            <h4><i class="fas fa-plus-circle text-success"></i> Devengado</h4>
                            <div class="breakdown-items">
                                <div class="breakdown-item">
                                    <span>Salario Base</span>
                                    <strong>$${salarioBase.toLocaleString()}</strong>
                                </div>
                                <div class="breakdown-item">
                                    <span>Bonificaciones</span>
                                    <strong>$${(devengado - salarioBase).toLocaleString()}</strong>
                                </div>
                            </div>
                            <div class="breakdown-total success">
                                <span>Total Devengado</span>
                                <strong>$${devengado.toLocaleString()}</strong>
                            </div>
                        </div>
                        
                        <div class="breakdown-section">
                            <h4><i class="fas fa-minus-circle text-danger"></i> Deducciones</h4>
                            <div class="breakdown-items">
                                <div class="breakdown-item">
                                    <span>Salud (4%)</span>
                                    <strong>$${deduccionSalud.toLocaleString()}</strong>
                                </div>
                                <div class="breakdown-item">
                                    <span>Pensión (4%)</span>
                                    <strong>$${deduccionPension.toLocaleString()}</strong>
                                </div>
                                ${otrasDeducciones > 0 ? `
                                <div class="breakdown-item">
                                    <span>Otras Deducciones</span>
                                    <strong>$${otrasDeducciones.toLocaleString()}</strong>
                                </div>
                                ` : ''}
                            </div>
                            <div class="breakdown-total danger">
                                <span>Total Deducciones</span>
                                <strong>$${deducciones.toLocaleString()}</strong>
                            </div>
                        </div>
                        
                        <div class="breakdown-section neto-section">
                            <div class="breakdown-total primary">
                                <span><i class="fas fa-hand-holding-usd"></i> Neto a Pagar</span>
                                <strong class="neto-amount">$${neto.toLocaleString()}</strong>
                            </div>
                        </div>
                    </div>
                    
                    ${liq.fecha_pago ? `
                    <div class="payment-info">
                        <i class="fas fa-check-circle"></i> 
                        Pagado el ${new Date(liq.fecha_pago).toLocaleDateString('es-CO', { 
                            day: 'numeric', 
                            month: 'long', 
                            year: 'numeric' 
                        })}
                    </div>
                    ` : ''}
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="cerrarModalLiquidacion()">Cerrar</button>
                    <button class="btn btn-primary" onclick="imprimirLiquidacion(${liq.id})">
                        <i class="fas fa-print"></i> Imprimir
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalContent);
}

function cerrarModalLiquidacion() {
    const modal = document.getElementById('modalDetalleLiquidacion');
    if (modal) {
        modal.remove();
    }
}

function imprimirLiquidacion(id) {
    alert('Función de impresión en desarrollo para liquidación #' + id);
}

// Cargar datos al iniciar
document.addEventListener('DOMContentLoaded', () => {
    loadEmployees();
    loadLiquidations();
});
</script>

{% endblock %}